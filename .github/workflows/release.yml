name: Package and release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Clone project
        uses: actions/checkout@v4

      - name: Luacheck
        uses: lunarmodules/luacheck@v1

  release:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Clone project
        uses: actions/checkout@v4

      - name: Package addon
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          sed -i "s/@project-version@/$VERSION/" FixNagrandMusic/FixNagrandMusic.toc
          zip -r "FixNagrandMusic-${VERSION}.zip" FixNagrandMusic/

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          gh release create "$GITHUB_REF_NAME" \
            "FixNagrandMusic-${VERSION}.zip" \
            --title "FixNagrandMusic $VERSION" \
            --generate-notes

      - name: Upload to CurseForge
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"

          # Find game version ID for TBC Classic Anniversary (2.5.5)
          GAME_VERSIONS=$(curl -sf -H "X-Api-Token: $CF_API_KEY" \
            "https://wow.curseforge.com/api/game/versions")

          VERSION_ID=$(echo "$GAME_VERSIONS" | jq -r \
            '[.[] | select(.name | test("2\\.5\\.5"))] | first | .id')

          if [ "$VERSION_ID" = "null" ] || [ -z "$VERSION_ID" ]; then
            echo "::error::Could not find game version ID for 2.5.5"
            echo "Available versions:"
            echo "$GAME_VERSIONS" | jq -r '.[] | "\(.id): \(.name)"'
            exit 1
          fi

          echo "Using game version ID: $VERSION_ID"

          METADATA=$(jq -nc \
            --argjson gv "[$VERSION_ID]" \
            --arg cl "Release $VERSION" \
            '{changelog: $cl, changelogType: "text", releaseType: "release", gameVersions: $gv}')

          RESPONSE=$(curl -sf -X POST \
            -H "X-Api-Token: $CF_API_KEY" \
            -F "metadata=$METADATA" \
            -F "file=@FixNagrandMusic-${VERSION}.zip" \
            "https://wow.curseforge.com/api/projects/1466355/upload-file")

          echo "CurseForge upload response: $RESPONSE"
