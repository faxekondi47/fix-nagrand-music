---
phase: 02-user-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FixNagrandMusic/FixNagrandMusic.toc
  - FixNagrandMusic/FixNagrandMusic.lua
autonomous: true
requirements:
  - UI-01
  - UI-02
  - UI-03
  - UI-04
  - UI-05

must_haves:
  truths:
    - "Player types /fng and sees one-line status with enabled/disabled state, subzone, and track file path"
    - "Player types /fng toggle and music fix turns off (StopMusic immediately) or back on (correct music resumes)"
    - "Player types /fng debug and zone/subzone change events print to chat in yellow with [DEBUG] tag"
    - "Player logs in and sees 'FNG: FixNagrandMusic v{version} loaded' with green FNG prefix"
    - "Player's toggle and debug settings survive logout and reload via SavedVariablesPerCharacter"
    - "All addon messages use |cFF00CC66FNG|r: prefix consistently (no old FixNagrandMusic: prefix remains)"
  artifacts:
    - path: "FixNagrandMusic/FixNagrandMusic.toc"
      provides: "SavedVariablesPerCharacter declaration"
      contains: "SavedVariablesPerCharacter: FixNagrandMusicDB"
    - path: "FixNagrandMusic/FixNagrandMusic.lua"
      provides: "Complete addon with slash commands, toggle, debug, login notification, persistence"
      contains: "SlashCmdList"
  key_links:
    - from: "ADDON_LOADED handler"
      to: "FixNagrandMusicDB global"
      via: "nil-check initialization with defaults"
      pattern: "ADDON_LOADED.*FixNagrandMusicDB"
    - from: "SlashCmdList FNG"
      to: "toggleAddon/showStatus/toggleDebug"
      via: "subcommand dispatch on msg:lower():match"
      pattern: 'SlashCmdList\["FNG"\]'
    - from: "activateAddon"
      to: "FixNagrandMusicDB.enabled"
      via: "early return guard"
      pattern: "FixNagrandMusicDB.enabled"
    - from: "PLAYER_LOGIN handler"
      to: "C_AddOns.GetAddOnMetadata"
      via: "version retrieval for login message"
      pattern: "GetAddOnMetadata.*Version"
---

<objective>
Add slash commands (/fng, /fng toggle, /fng debug), login notification, and persisted settings to the existing core music fix addon.

Purpose: Give the player control over the addon -- check status, toggle on/off, enable debug output -- and confirm the addon loaded at login. All settings persist per-character across sessions.

Output: Updated FixNagrandMusic.toc (SavedVariablesPerCharacter) and FixNagrandMusic.lua (slash commands, toggle, debug, login notification, persistence infrastructure).
</objective>

<execution_context>
@/home/mig/.claude/get-shit-done/workflows/execute-plan.md
@/home/mig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-user-interface/02-RESEARCH.md
@FixNagrandMusic/FixNagrandMusic.toc
@FixNagrandMusic/FixNagrandMusic.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add persistence infrastructure, utility functions, enabled guards, and FileDataID lookup</name>
  <files>FixNagrandMusic/FixNagrandMusic.toc, FixNagrandMusic/FixNagrandMusic.lua</files>
  <action>
**TOC change (UI-05):**
Change `## SavedVariables: FixNagrandMusicDB` to `## SavedVariablesPerCharacter: FixNagrandMusicDB` in the TOC file. This makes toggle/debug settings per-character. No migration needed (pre-release addon).

**Lua changes -- all in FixNagrandMusic.lua:**

**Section 1 (MUSIC DATA) -- add TRACK_PATHS lookup table (UI-01):**
After the existing `NAGRAND_TRACKS` table and before `NAGRAND_MAP_ID`, add a FileDataID-to-path lookup table for the status display:
```lua
-- FileDataID to file path lookup for status display (UI-01)
-- No runtime API exists to resolve FileDataID to path; hardcoded from Wowhead TBC sound database
local TRACK_PATHS = {
    [53585] = "Sound\\Music\\ZoneMusic\\Nagrand\\NA_GeneralWalkDay01.mp3",
    [53586] = "Sound\\Music\\ZoneMusic\\Nagrand\\NA_GeneralWalkDay02.mp3",
    [53587] = "Sound\\Music\\ZoneMusic\\Nagrand\\NA_GeneralWalkDay03.mp3",
    [53588] = "Sound\\Music\\ZoneMusic\\Nagrand\\NA_GeneralWalkNight01.mp3",
    [53589] = "Sound\\Music\\ZoneMusic\\Nagrand\\NA_GeneralWalkNight02.mp3",
    [53590] = "Sound\\Music\\ZoneMusic\\Nagrand\\NA_GeneralWalkNight03.mp3",
}
```

**Section 3 (UTILITY FUNCTIONS) -- update print functions and add new ones:**

Replace `printError()` to use new FNG prefix:
```lua
local FNG_PREFIX = "|cFF00CC66FNG|r: "

local function printError(msg)
    print(FNG_PREFIX .. "|cFFFF0000" .. msg .. "|r")
end
```

Replace `printInfo()` to use new FNG prefix:
```lua
local function printInfo(msg)
    print(FNG_PREFIX .. msg)
end
```

Add `printDebug()` after `printInfo()`:
```lua
local function printDebug(msg)
    if FixNagrandMusicDB and FixNagrandMusicDB.debug then
        print(FNG_PREFIX .. "|cFFFFFF00[DEBUG] " .. msg .. "|r")
    end
end
```

Add `getAddonVersion()` after `printDebug()`:
```lua
local function getAddonVersion()
    if C_AddOns and C_AddOns.GetAddOnMetadata then
        local version = C_AddOns.GetAddOnMetadata("FixNagrandMusic", "Version")
        if version and not version:find("@") then
            return version
        end
    end
    return "dev"
end
```

**Section 6 (MUSIC PLAYBACK) -- add enabled guard to `playNagrandMusic()` (UI-02):**
Add as the FIRST check in `playNagrandMusic()`, before `updateSubzone()`:
```lua
    -- Respect toggle state (UI-02)
    if FixNagrandMusicDB and not FixNagrandMusicDB.enabled then
        return
    end
```

**Section 8 (ACTIVATION/DEACTIVATION) -- add enabled guard to `activateAddon()` (UI-02):**
Add as the FIRST line in `activateAddon()`:
```lua
    -- Respect toggle state (UI-02)
    if FixNagrandMusicDB and not FixNagrandMusicDB.enabled then
        return
    end
```

**Section 9 (EVENT HANDLERS) -- add ADDON_LOADED handler (UI-05):**
Add BEFORE the existing `ZONE_CHANGED_NEW_AREA` handler:
```lua
-- SavedVariables initialization (UI-05)
function handlers.ADDON_LOADED(addonName)
    if addonName ~= "FixNagrandMusic" then return end
    if FixNagrandMusicDB == nil then
        FixNagrandMusicDB = {}
    end
    if FixNagrandMusicDB.enabled == nil then
        FixNagrandMusicDB.enabled = true
    end
    if FixNagrandMusicDB.debug == nil then
        FixNagrandMusicDB.debug = false
    end
    frame:UnregisterEvent("ADDON_LOADED")
end
```

Note: `frame` is referenced before its declaration in Section 10. This is fine because `ADDON_LOADED` fires at runtime (after file execution completes and frame is created). The handlers table pattern means the function is stored but not called until the event fires.

**Important:** Do NOT add debug prints to event handlers yet -- that is Task 2. Do NOT add PLAYER_LOGIN or slash commands yet -- Task 2.
  </action>
  <verify>
Read the modified files and verify:
1. TOC has `SavedVariablesPerCharacter` (not `SavedVariables`)
2. TRACK_PATHS table has all 6 entries with correct FileDataIDs
3. FNG_PREFIX constant exists and is used by printError, printInfo, printDebug
4. getAddonVersion() handles both C_AddOns path and @project-version@ token
5. playNagrandMusic() has enabled guard as first check
6. activateAddon() has enabled guard as first check
7. handlers.ADDON_LOADED exists with nil-check initialization for enabled and debug
8. No old "|cFFFF0000FixNagrandMusic Error:|r" or "|cFF00FF00FixNagrandMusic:|r" prefix strings remain
  </verify>
  <done>TOC declares SavedVariablesPerCharacter. Lua has TRACK_PATHS lookup, updated FNG-prefixed print functions, printDebug, getAddonVersion, enabled guards in playNagrandMusic and activateAddon, and ADDON_LOADED handler initializing FixNagrandMusicDB defaults. All Phase 1 behavior preserved -- addon still works identically, just with new prefix and enabled guard (defaults to true).</done>
</task>

<task type="auto">
  <name>Task 2: Add slash commands, login notification, debug prints, and toggle logic</name>
  <files>FixNagrandMusic/FixNagrandMusic.lua</files>
  <action>
**Section 9 (EVENT HANDLERS) -- add debug prints to zone event handlers (UI-03):**

Inside `handlers.ZONE_CHANGED_NEW_AREA()`, add a debug print INSIDE the deferred callback (after `C_Timer.After(0, function()`, before the if/else), so it shows the actual zone being acted on:
```lua
        printDebug("ZONE_CHANGED_NEW_AREA: " .. (GetZoneText() or "?") .. " / " .. (GetSubZoneText() or ""))
```

Inside `handlers.ZONE_CHANGED()`, add a debug print at the very top of the function (before the `if isActive` check):
```lua
    printDebug("ZONE_CHANGED: " .. (GetZoneText() or "?") .. " / " .. (GetSubZoneText() or ""))
```

Inside `handlers.ZONE_CHANGED_INDOORS()`, add a debug print at the very top of the function (before the `if isActive` check):
```lua
    printDebug("ZONE_CHANGED_INDOORS: " .. (GetZoneText() or "?") .. " / " .. (GetSubZoneText() or ""))
```

Per user decision: debug prints zone/subzone change events ONLY. No music calls, no timer ticks.

**Section 9 (EVENT HANDLERS) -- add PLAYER_LOGIN handler (UI-04):**
Add after the ADDON_LOADED handler:
```lua
-- Login notification (UI-04)
function handlers.PLAYER_LOGIN()
    local version = getAddonVersion()
    local msg = "FixNagrandMusic v" .. version .. " loaded"
    if not FixNagrandMusicDB.enabled then
        msg = msg .. " (disabled)"
    end
    printInfo(msg)
end
```

Per user decisions:
- Every login, not first-time only
- Green FNG prefix (same as all messages, via printInfo)
- Show "(disabled)" only when disabled; no qualifier when enabled
- Format: `FNG: FixNagrandMusic v{version} loaded`

**Section 11 (NEW) -- add slash command registration (UI-01, UI-02, UI-03):**
After Section 10 (FRAME SETUP), add a new Section 11:

```lua
-- === SECTION 11: SLASH COMMANDS (UI-01, UI-02, UI-03) ===

local function showStatus()
    if not FixNagrandMusicDB.enabled then
        printInfo("Disabled")
        return
    end
    if not isActive then
        printInfo("Enabled | Not in Nagrand")
        return
    end
    local path = TRACK_PATHS[currentTrackID] or "No track playing"
    local subzone = currentSubzone
    if not subzone or subzone == "" then
        subzone = "open area"
    end
    printInfo("Enabled | " .. subzone .. " | " .. path)
end

local function toggleAddon()
    FixNagrandMusicDB.enabled = not FixNagrandMusicDB.enabled
    if FixNagrandMusicDB.enabled then
        printInfo("Enabled")
        if isInNagrand() then
            activateAddon()
        end
    else
        printInfo("Disabled")
        deactivateAddon()
    end
end

local function toggleDebug()
    FixNagrandMusicDB.debug = not FixNagrandMusicDB.debug
    if FixNagrandMusicDB.debug then
        printInfo("Debug mode ON")
    else
        printInfo("Debug mode OFF")
    end
end

SLASH_FNG1 = "/fng"
SlashCmdList["FNG"] = function(msg)
    local command = msg:lower():match("^(%S+)") or ""
    if command == "toggle" then
        toggleAddon()
    elseif command == "debug" then
        toggleDebug()
    else
        showStatus()
    end
end
```

Per user decisions:
- `/fng` with no args or unknown args shows status (one-liner, context-aware)
- `/fng toggle` only -- no `/fng on` or `/fng off` aliases
- Toggle OFF: StopMusic immediately via deactivateAddon()
- Toggle ON in Nagrand: activateAddon() starts music right away
- Confirmation: simple "FNG: Enabled" / "FNG: Disabled"
- Status shows actual file path (e.g. `Sound\Music\ZoneMusic\Nagrand\NA_GeneralWalkDay01.mp3`), not friendly name
- No version in status output
  </action>
  <verify>
Read the modified FixNagrandMusic.lua and verify:
1. Section 11 exists with SLASH_FNG1, SlashCmdList["FNG"], showStatus, toggleAddon, toggleDebug
2. handlers.PLAYER_LOGIN exists and uses getAddonVersion() with "(disabled)" conditional
3. Debug prints exist inside ZONE_CHANGED_NEW_AREA (inside deferred callback), ZONE_CHANGED, and ZONE_CHANGED_INDOORS
4. showStatus() outputs one-liner format with TRACK_PATHS lookup for file path
5. toggleAddon() calls deactivateAddon() when disabling and activateAddon() when enabling in Nagrand
6. toggleDebug() flips FixNagrandMusicDB.debug
7. PLAYER_LOGIN is registered (by the existing for-loop in Section 10 that registers all handlers)
  </verify>
  <done>Player can type /fng to see status, /fng toggle to enable/disable, /fng debug to toggle debug output. Login shows "FNG: FixNagrandMusic v{version} loaded" with "(disabled)" suffix when off. Debug mode prints zone/subzone change events in yellow. All settings persist via SavedVariablesPerCharacter.</done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full Phase 2 integration:

1. **TOC declares SavedVariablesPerCharacter** (not SavedVariables): `grep "SavedVariablesPerCharacter" FixNagrandMusic/FixNagrandMusic.toc`
2. **No old prefix strings remain**: `grep "FixNagrandMusic Error\|FixNagrandMusic:" FixNagrandMusic/FixNagrandMusic.lua` should return zero matches (only comments allowed)
3. **All 5 requirements covered**:
   - UI-01: showStatus() function + TRACK_PATHS table + slash command dispatch
   - UI-02: toggleAddon() function + enabled guards in activateAddon/playNagrandMusic
   - UI-03: toggleDebug() function + printDebug() in zone event handlers
   - UI-04: handlers.PLAYER_LOGIN with getAddonVersion()
   - UI-05: SavedVariablesPerCharacter TOC + ADDON_LOADED handler with defaults
4. **Events registered**: ADDON_LOADED and PLAYER_LOGIN are in the handlers table and will be registered by the Section 10 for-loop
5. **Enabled guard coverage**: Both activateAddon() and playNagrandMusic() check FixNagrandMusicDB.enabled
6. **Section count**: Lua file now has 11 sections (10 original + Section 11: SLASH COMMANDS)
</verification>

<success_criteria>
1. `/fng` displays one-liner status with enabled/disabled, subzone, track file path
2. `/fng toggle` immediately stops or starts music, prints "FNG: Enabled" / "FNG: Disabled"
3. `/fng debug` toggles debug mode, prints "FNG: Debug mode ON" / "FNG: Debug mode OFF"
4. Login prints "FNG: FixNagrandMusic v{version} loaded" (or with "(disabled)" suffix)
5. Settings persist across /reload via SavedVariablesPerCharacter
6. All messages use `|cFF00CC66FNG|r:` prefix consistently
7. Debug prints show only zone/subzone change events (ZONE_CHANGED_NEW_AREA, ZONE_CHANGED, ZONE_CHANGED_INDOORS)
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-interface/02-01-SUMMARY.md`
</output>
