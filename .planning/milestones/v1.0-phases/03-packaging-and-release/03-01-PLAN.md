---
phase: 03-packaging-and-release
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/release.yml
  - .luacheckrc
  - .pkgmeta
  - FixNagrandMusic/FixNagrandMusic.toc
  - README.md
autonomous: true
requirements:
  - PKG-02
  - PKG-03
  - PKG-04
user_setup:
  - service: CurseForge
    why: "CurseForge project must exist before first automated upload"
    env_vars:
      - name: CF_API_KEY
        source: "https://wow.curseforge.com/account/api-tokens -> Generate API Token"
    dashboard_config:
      - task: "Create CurseForge project for FixNagrandMusic"
        location: "https://wow.curseforge.com -> Start a Project -> select TBC Classic Anniversary, Category: Audio & Video"
      - task: "Add CF_API_KEY secret to GitHub repo"
        location: "https://github.com/faxekondi47/fix-nagrand-music/settings/secrets/actions -> New repository secret -> Name: CF_API_KEY"
      - task: "Copy CurseForge project ID into .toc"
        location: "CurseForge project page -> right sidebar shows Project ID number -> replace REPLACE_WITH_ACTUAL_ID in FixNagrandMusic.toc"

must_haves:
  truths:
    - "Pushing a v* git tag triggers the GitHub Actions release workflow"
    - "Luacheck lint runs and passes before packaging"
    - "BigWigsMods/packager produces a release zip with FixNagrandMusic/ folder"
    - "GitHub Release is created with the packaged zip attached"
    - "CurseForge upload is configured (requires CF_API_KEY secret and project ID)"
    - "README shows installation instructions and /fng command usage"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Tag-triggered CI/CD pipeline: lint -> package -> release"
      contains: "BigWigsMods/packager@v2"
    - path: ".luacheckrc"
      provides: "Lua linting config with WoW API globals whitelisted"
      contains: "std = \"lua51\""
    - path: ".pkgmeta"
      provides: "BigWigsMods packager metadata for zip packaging"
      contains: "package-as: FixNagrandMusic"
    - path: "FixNagrandMusic/FixNagrandMusic.toc"
      provides: "CurseForge project ID metadata for automated upload"
      contains: "X-Curse-Project-ID"
    - path: "README.md"
      provides: "User-facing documentation with install and usage instructions"
      contains: "/fng"
  key_links:
    - from: ".github/workflows/release.yml"
      to: ".luacheckrc"
      via: "lunarmodules/luacheck@v1 reads .luacheckrc for lint config"
      pattern: "lunarmodules/luacheck"
    - from: ".github/workflows/release.yml"
      to: ".pkgmeta"
      via: "BigWigsMods/packager@v2 reads .pkgmeta for packaging rules"
      pattern: "BigWigsMods/packager"
    - from: ".pkgmeta"
      to: "README.md"
      via: "ignore directive excludes README from packaged zip"
      pattern: "README.md"
---

<objective>
Set up the complete CI/CD pipeline and user-facing documentation for FixNagrandMusic so that pushing a git tag automatically lints, packages, and publishes the addon to GitHub Releases and CurseForge, with a README for users finding the addon.

Purpose: The addon is feature-complete. This plan makes it distributable and discoverable.
Output: GitHub Actions workflow, luacheck config, .pkgmeta, CurseForge metadata in .toc, and README.md
</objective>

<execution_context>
@/home/mig/.claude/get-shit-done/workflows/execute-plan.md
@/home/mig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-packaging-and-release/03-RESEARCH.md
@FixNagrandMusic/FixNagrandMusic.toc
@FixNagrandMusic/FixNagrandMusic.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CI/CD pipeline and packaging config</name>
  <files>
    .github/workflows/release.yml
    .luacheckrc
    .pkgmeta
    FixNagrandMusic/FixNagrandMusic.toc
  </files>
  <action>
Create 3 new files and modify the .toc:

**1. `.github/workflows/release.yml`** -- Tag-triggered release pipeline:
- Trigger: `push: tags: - "v*"` (no manual dispatch)
- Permissions: `contents: write` (required for creating GitHub Releases)
- Job `lint`: `actions/checkout@v4` then `lunarmodules/luacheck@v1`
- Job `release`: `needs: lint`, env vars `CF_API_KEY: ${{ secrets.CF_API_KEY }}` and `GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}`, checkout with `fetch-depth: 0` (full history for changelog + tag detection), then `BigWigsMods/packager@v2`
- Use the exact structure from 03-RESEARCH.md Pattern 2 (Complete GitHub Actions Workflow example)

**2. `.luacheckrc`** -- Lua linting for WoW addon:
- `std = "lua51"` (WoW's Lua runtime)
- `max_line_length = false` (no line length enforcement)
- `exclude_files = { ".release" }` (packager build directory)
- `globals` table: `FixNagrandMusicDB` (SavedVariablesPerCharacter), `SLASH_FNG1`, `SlashCmdList` (slash command registration)
- `read_globals` table: only the WoW API functions the addon actually uses -- `CreateFrame`, `UIParent`, `C_Map`, `GetZoneText`, `GetSubZoneText`, `PlayMusic`, `StopMusic`, `GetGameTime`, `C_Timer`, `GetCVar`, `SetCVar`, `C_AddOns`, `print`
- Also add `frame` as a `globals` entry -- it is a module-level local used before its declaration by the `handlers.ADDON_LOADED` function (line 261 references `frame` which is declared at line 332). Actually, wait -- `frame` is declared as `local frame` at line 332. Luacheck handles locals fine. But `handlers.ADDON_LOADED` at line 261 uses `frame:UnregisterEvent` and `frame` isn't declared until line 332. Since luacheck does top-to-bottom analysis of locals, it will see `frame` as an undefined variable at line 261. However, in Lua this works at runtime because the function body isn't executed until after `frame` exists. Luacheck will flag it as "accessing undefined variable 'frame'." To handle this: add `-- luacheck: globals frame` inline OR restructure. Best approach: add `"frame"` to the globals list in `.luacheckrc` to suppress the warning since it IS a valid module-level variable that works correctly at runtime. Actually, `frame` is a `local` -- luacheck won't consider it a global. Luacheck performs whole-file analysis for locals. It will see `local frame = CreateFrame("Frame")` at line 332 and know about it for the entire file scope. So no issue -- do NOT add `frame` to globals.
- Use the exact globals list from 03-RESEARCH.md .luacheckrc example

**3. `.pkgmeta`** -- BigWigsMods packager metadata:
- `package-as: FixNagrandMusic`
- `ignore:` list: `.github`, `.luacheckrc`, `.planning`, `README.md`
- Minimal config -- no `externals`, no `move-folders`, no `enable-nolib-creation`
- Files beginning with `.` (like `.pkgmeta`, `.gitignore`) are auto-ignored by the packager -- do NOT list them

**4. `FixNagrandMusic/FixNagrandMusic.toc`** -- Add CurseForge metadata:
- Add `## X-Curse-Project-ID: REPLACE_WITH_ACTUAL_ID` line after the existing `## X-Category` line
- The user will replace the placeholder with the actual numeric ID after creating the CurseForge project (see user_setup)
- Do NOT modify any other .toc lines -- the `@project-version@` and Interface version are already correct

Run `luacheck FixNagrandMusic/` locally (if luacheck is available) to verify the config works. If luacheck is not installed, verify the `.luacheckrc` syntax is valid Lua by checking with `lua -e "dofile('.luacheckrc')"` or similar. If neither is available, verify manually that the globals list matches every global variable access in FixNagrandMusic.lua.
  </action>
  <verify>
1. `.github/workflows/release.yml` exists and contains: `on: push: tags:`, `BigWigsMods/packager@v2`, `lunarmodules/luacheck@v1`, `fetch-depth: 0`, `CF_API_KEY`, `GITHUB_OAUTH`, `permissions: contents: write`
2. `.luacheckrc` exists and contains: `std = "lua51"`, all WoW API globals from FixNagrandMusic.lua listed in `read_globals`
3. `.pkgmeta` exists with `package-as: FixNagrandMusic` and `ignore` list including `.planning` and `README.md`
4. `FixNagrandMusic/FixNagrandMusic.toc` contains `## X-Curse-Project-ID:` line
5. Grep FixNagrandMusic.lua for all uppercase global function calls and verify each appears in `.luacheckrc` as either `globals` or `read_globals`
  </verify>
  <done>Complete CI/CD pipeline configured: tag push triggers lint -> package -> GitHub Release + CurseForge upload. Luacheck config whitelists all WoW API globals used by the addon. Packager metadata correctly packages FixNagrandMusic/ folder and excludes dev files from the zip.</done>
</task>

<task type="auto">
  <name>Task 2: Write README with installation and usage instructions</name>
  <files>
    README.md
  </files>
  <action>
Create `README.md` in the project root with the following content and constraints:

**Tone:** Casual and friendly -- conversational, approachable, like a community addon post. NOT corporate, NOT dry technical documentation.

**Structure:**
1. **Title:** `# FixNagrandMusic` (plain, no emoji)
2. **Bug explanation:** 1-2 sentences explaining the bug -- Orgrimmar drum music plays in Nagrand instead of the correct zone music in TBC Classic Anniversary. Keep it concise and relatable ("You know that annoying drum music..." style).
3. **What it does:** 1-2 sentences -- the addon detects Nagrand and plays the correct original TBC music tracks with day/night variants.
4. **Installation:** Short section with two methods:
   - CurseForge: Download from CurseForge (link placeholder) or install via CurseForge app
   - Manual: Download the latest release from GitHub Releases, extract `FixNagrandMusic` folder into `World of Warcraft/_classic_/Interface/AddOns/`
5. **Usage:** List the three `/fng` commands:
   - `/fng` -- Show current status (enabled/disabled, subzone, track)
   - `/fng toggle` -- Turn the fix on or off
   - `/fng debug` -- Toggle debug output for zone events
6. **Brief closing:** One sentence pointing to GitHub Issues for bug reports

**Locked constraints (from user decisions):**
- NO troubleshooting/FAQ section
- NO screenshots or media
- NO lengthy explanations
- Keep it SHORT overall -- install, usage, done
  </action>
  <verify>
1. `README.md` exists in project root
2. Contains installation instructions (both CurseForge and manual methods)
3. Contains all three `/fng` commands documented
4. Does NOT contain a troubleshooting/FAQ section
5. Does NOT contain screenshots or image references
6. Tone reads casual and friendly, not corporate
  </verify>
  <done>README.md provides concise, friendly documentation covering what the addon does, how to install it, and how to use the /fng commands. No troubleshooting section, no screenshots, no bloat.</done>
</task>

</tasks>

<verification>
1. All 5 files exist: `.github/workflows/release.yml`, `.luacheckrc`, `.pkgmeta`, `README.md`, `FixNagrandMusic/FixNagrandMusic.toc` (modified)
2. Workflow triggers on `v*` tag push only
3. Lint job runs before release job (`needs: lint`)
4. Packager uses `fetch-depth: 0` for full git history
5. `.pkgmeta` excludes `.planning`, `.github`, `.luacheckrc`, `README.md` from the packaged zip
6. `.luacheckrc` covers every global variable access in FixNagrandMusic.lua
7. `.toc` has `X-Curse-Project-ID` line (placeholder OK -- user fills in actual ID)
8. README covers installation and all three `/fng` commands
</verification>

<success_criteria>
- PKG-02: GitHub Actions workflow exists at `.github/workflows/release.yml` with tag trigger, lint step, and BigWigsMods/packager@v2 release step
- PKG-03: `.pkgmeta` correctly configures `package-as: FixNagrandMusic` with dev file exclusions; `.toc` has CurseForge project ID field
- PKG-04: `README.md` has installation instructions, `/fng` command usage, and casual friendly tone
</success_criteria>

<output>
After completion, create `.planning/phases/03-packaging-and-release/03-01-SUMMARY.md`
</output>
