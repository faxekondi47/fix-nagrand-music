---
phase: 01-core-music-fix
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - FixNagrandMusic/FixNagrandMusic.lua
autonomous: true
requirements:
  - MFIX-02
gap_closure: true

must_haves:
  truths:
    - "Addon calls GetSubZoneText() and stores the current subzone name in a state variable"
    - "Subzone name updates on ZONE_CHANGED, ZONE_CHANGED_INDOORS, and PLAYER_ENTERING_WORLD events"
    - "Existing music playback logic is unchanged -- single track pool, no per-subzone overrides"
    - "currentSubzone is accessible for Phase 2 UI-01 slash command status display"
  artifacts:
    - path: "FixNagrandMusic/FixNagrandMusic.lua"
      provides: "GetSubZoneText()-based subzone tracking added to existing addon"
      contains: "GetSubZoneText"
  key_links:
    - from: "FixNagrandMusic/FixNagrandMusic.lua"
      to: "GetSubZoneText WoW API"
      via: "Called in event handlers to populate currentSubzone state variable"
      pattern: "GetSubZoneText\\(\\)"
---

<objective>
Close the MFIX-02 verification gap by adding GetSubZoneText() subzone tracking to the existing addon.

Purpose: The verification report found that MFIX-02 ("Addon detects player's current subzone within Nagrand via GetSubZoneText()") is only partially satisfied. The music works correctly in all subzones via the single-pool design, but GetSubZoneText() is never called, so the addon cannot report which subzone the player is in. This matters for Phase 2 (UI-01 shows "current subzone" in `/fng` status output). Adding subzone tracking satisfies MFIX-02 literally and prepares the data Phase 2 needs.

Output: Updated FixNagrandMusic.lua with currentSubzone state variable populated by GetSubZoneText() on every zone/subzone event.
</objective>

<execution_context>
@/home/mig/.claude/get-shit-done/workflows/execute-plan.md
@/home/mig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-music-fix/01-01-SUMMARY.md
@.planning/phases/01-core-music-fix/01-VERIFICATION.md
@FixNagrandMusic/FixNagrandMusic.lua
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GetSubZoneText() subzone tracking to FixNagrandMusic.lua</name>
  <files>FixNagrandMusic/FixNagrandMusic.lua</files>
  <action>
Add a `currentSubzone` state variable and populate it via GetSubZoneText() on subzone events. This is a surgical addition -- do NOT change any music playback logic. The single-pool design is confirmed correct by in-game testing.

Specific changes:

1. **SECTION 2 (STATE VARIABLES):** Add `local currentSubzone = nil` after the existing state variables. Add a comment: `-- current subzone name from GetSubZoneText() (MFIX-02, used by Phase 2 UI-01)`

2. **Create a helper function** (after SECTION 3 UTILITY FUNCTIONS or within SECTION 4):
```lua
-- Update the tracked subzone name (MFIX-02)
local function updateSubzone()
    currentSubzone = GetSubZoneText() or ""
end
```

3. **SECTION 6 (playNagrandMusic function):** At the START of playNagrandMusic() (before the music-disabled check), add a call to `updateSubzone()`. This ensures the subzone is tracked every time the addon considers playing music -- on zone entry, subzone change, and loading screen recovery.

4. **SECTION 8 (deactivateAddon function):** After `stopNagrandMusic()`, add `currentSubzone = nil` to reset subzone state on zone exit, alongside the other state resets.

5. **Do NOT change:**
   - Music track selection logic (single pool stays)
   - Event handler registrations
   - Day/night timer logic
   - Any existing state variable behavior
   - The existing comment structure (keep all SECTION headers intact)

The result: after every ZONE_CHANGED, ZONE_CHANGED_INDOORS, ZONE_CHANGED_NEW_AREA, and PLAYER_ENTERING_WORLD event that triggers playNagrandMusic(), the `currentSubzone` variable will contain the player's current subzone text (e.g., "Sunspring Post", "Garadar", or "" for unnamed areas). Phase 2 can read this variable for the `/fng` status display.
  </action>
  <verify>
1. Grep for "GetSubZoneText" in FixNagrandMusic.lua -- must appear at least once
2. Grep for "currentSubzone" in FixNagrandMusic.lua -- must appear in state variables, updateSubzone function, playNagrandMusic, and deactivateAddon
3. Confirm no changes to NAGRAND_TRACKS, getRandomTrack, isTrackInCurrentPool, or startDayNightTimer functions (diff against known good state)
4. Count total lines -- should be approximately 275-285 (was 266, adding ~10-15 lines)
  </verify>
  <done>
- GetSubZoneText() is called in the addon via updateSubzone() helper
- currentSubzone state variable exists and is populated on every subzone-relevant event
- currentSubzone is reset to nil on zone exit (deactivateAddon)
- All existing music playback logic is byte-identical to pre-change behavior (no functional changes to playback)
- MFIX-02 requirement ("detects player's current subzone within Nagrand via GetSubZoneText()") is literally satisfied
  </done>
</task>

<task type="auto">
  <name>Task 2: Update REQUIREMENTS.md traceability for MFIX-02 closure</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
Update the MFIX-02 entry in REQUIREMENTS.md to reflect that it is now fully satisfied:

1. Find the MFIX-02 line: `- [ ] **MFIX-02**: Addon detects player's current subzone within Nagrand via GetSubZoneText()`
2. Change the checkbox to checked: `- [x] **MFIX-02**: ...`

No other changes needed. The requirement text stays the same -- the implementation now matches it.
  </action>
  <verify>
Grep REQUIREMENTS.md for "MFIX-02" -- line must start with `- [x]` (checked).
  </verify>
  <done>
MFIX-02 marked as satisfied in REQUIREMENTS.md, matching the code change in Task 1.
  </done>
</task>

</tasks>

<verification>
1. `GetSubZoneText()` appears in FixNagrandMusic.lua (grep confirms)
2. `currentSubzone` variable is declared, set, and cleared appropriately
3. Music playback functions (getRandomTrack, isTrackInCurrentPool, playNagrandMusic track selection, startDayNightTimer) are unchanged
4. MFIX-02 is marked [x] in REQUIREMENTS.md
5. The addon's existing in-game-validated behavior is preserved -- this change ONLY adds state tracking, it does not alter any PlayMusic/StopMusic calls
</verification>

<success_criteria>
- MFIX-02 verification gap is closed: GetSubZoneText() is called and subzone name is tracked
- Zero changes to music playback behavior (all in-game validation from Plan 01-02 remains valid)
- currentSubzone is available as a module-level local for Phase 2 to read when implementing `/fng` status
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-music-fix/01-03-SUMMARY.md`
</output>
