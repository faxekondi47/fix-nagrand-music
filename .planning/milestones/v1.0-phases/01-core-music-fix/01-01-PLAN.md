---
phase: 01-core-music-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FixNagrandMusic/FixNagrandMusic.toc
  - FixNagrandMusic/FixNagrandMusic.lua
autonomous: true
requirements:
  - MFIX-01
  - MFIX-02
  - MFIX-03
  - MFIX-04
  - MFIX-05
  - MFIX-06
  - MFIX-07
  - MFIX-08
  - MFIX-09
  - PKG-01

must_haves:
  truths:
    - "Addon loads without errors when placed in WoW Interface/AddOns directory"
    - "Addon detects Nagrand zone entry using dual-method detection (UiMapID + GetZoneText fallback)"
    - "Correct day tracks (53585-53587) play during daytime hours (6:00-17:59)"
    - "Correct night tracks (53588-53590) play during nighttime hours (18:00-5:59)"
    - "Music continues uninterrupted across subzone boundaries within Nagrand"
    - "Music restarts after loading screens (hearthing, dungeons, BGs)"
    - "Addon stops music and cleans up when player leaves Nagrand"
    - "Addon does nothing outside Nagrand"
    - "Music switches from day to night tracks (and vice versa) when game time transitions, even while standing still"
    - "Addon respects user's Sound_EnableMusic setting -- does nothing if music is disabled"
    - "Visible error message in chat if addon cannot determine correct track"
  artifacts:
    - path: "FixNagrandMusic/FixNagrandMusic.toc"
      provides: "Addon manifest for TBC Classic Anniversary"
      contains: "Interface: 20505"
    - path: "FixNagrandMusic/FixNagrandMusic.lua"
      provides: "Complete addon logic -- zone detection, music playback, day/night, cleanup"
      min_lines: 120
  key_links:
    - from: "FixNagrandMusic/FixNagrandMusic.toc"
      to: "FixNagrandMusic/FixNagrandMusic.lua"
      via: "TOC file list loads Lua file"
      pattern: "FixNagrandMusic\\.lua"
    - from: "FixNagrandMusic/FixNagrandMusic.lua"
      to: "WoW Events"
      via: "Event handler dispatches ZONE_CHANGED_NEW_AREA, ZONE_CHANGED, ZONE_CHANGED_INDOORS, PLAYER_ENTERING_WORLD, PLAYER_LOGOUT"
      pattern: "RegisterEvent"
    - from: "FixNagrandMusic/FixNagrandMusic.lua"
      to: "PlayMusic API"
      via: "Plays FileDataIDs from NAGRAND_TRACKS table"
      pattern: "PlayMusic"
    - from: "FixNagrandMusic/FixNagrandMusic.lua"
      to: "Day/night timer"
      via: "C_Timer.After(60) periodic check triggers track switch on time-of-day change"
      pattern: "C_Timer\\.After"
---

<objective>
Create the complete FixNagrandMusic addon -- both the TOC manifest and the Lua source file containing all core music fix logic.

Purpose: This is the addon's entire reason for existing. When installed, it detects Nagrand, suppresses the buggy Orgrimmar drum music, and plays the correct original TBC Nagrand tracks with day/night variants. It handles loading screens, subzone transitions, and cleanup on exit.

Output: A fully functional WoW addon in `FixNagrandMusic/` directory ready to be copied into `Interface/AddOns/`.
</objective>

<execution_context>
@/home/mig/.claude/get-shit-done/workflows/execute-plan.md
@/home/mig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-music-fix/01-RESEARCH.md
@.planning/phases/01-core-music-fix/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FixNagrandMusic.toc addon manifest</name>
  <files>FixNagrandMusic/FixNagrandMusic.toc</files>
  <action>
Create `FixNagrandMusic/FixNagrandMusic.toc` with the following fields:

```toc
## Interface: 20505
## Title: FixNagrandMusic
## Notes: Fixes the bug where Orgrimmar drum music plays in Nagrand instead of the correct zone music.
## Author: [author name from git config or leave as-is]
## Version: @project-version@
## X-Category: Audio & Video
## SavedVariables: FixNagrandMusicDB

FixNagrandMusic.lua
```

Key details:
- Interface 20505 = TBC Classic Anniversary (2.5.5). Per research, this needs in-game validation but is the best-known value.
- `@project-version@` is a token replaced by BigWigsMods packager during release (Phase 3). In development it displays literally, which is fine.
- `SavedVariables: FixNagrandMusicDB` is declared now for Phase 2 compatibility (toggle/debug state). The addon does not use it in Phase 1, but declaring it early avoids a TOC change later.
- File must end with a newline.
- The folder name `FixNagrandMusic/` MUST match the TOC filename (WoW requirement).
  </action>
  <verify>File exists at `FixNagrandMusic/FixNagrandMusic.toc`. Contains `Interface: 20505`. Contains `FixNagrandMusic.lua` as the file to load. No trailing whitespace on metadata lines.</verify>
  <done>TOC file is valid and ready for the WoW client to load the addon.</done>
</task>

<task type="auto">
  <name>Task 2: Create FixNagrandMusic.lua with complete addon logic</name>
  <files>FixNagrandMusic/FixNagrandMusic.lua</files>
  <action>
Create `FixNagrandMusic/FixNagrandMusic.lua` implementing the full core music fix. The file should be organized into these sections with clear `-- === SECTION ===` comment headers:

**Section 1: Music Data**
- `NAGRAND_TRACKS` table with `day = { 53585, 53586, 53587 }` and `night = { 53588, 53589, 53590 }`
- `NAGRAND_MAP_ID = 107` (UiMapID -- needs in-game validation, may be 477)
- `NAGRAND_ZONE_TEXT = "Nagrand"` (fallback detection)

**Section 2: State Variables**
- `currentTrackID = nil` -- currently playing FileDataID
- `isActive = false` -- whether addon is actively managing music
- `lastTimeOfDay = nil` -- last known day/night state (boolean: true=day)
- `savedMusicCVar = nil` -- user's original Sound_EnableMusic value

**Section 3: Utility Functions**
- `printError(msg)` -- prints "|cFFFF0000FixNagrandMusic Error:|r " .. msg
- `printInfo(msg)` -- prints "|cFF00FF00FixNagrandMusic:|r " .. msg

**Section 4: Zone Detection (MFIX-01, MFIX-02)**
- `isInNagrand()` -- dual-method detection:
  1. Try `C_Map.GetBestMapForUnit("player")` == NAGRAND_MAP_ID (locale-safe)
  2. Fallback: `GetZoneText() == NAGRAND_ZONE_TEXT`
  - Return true if either matches
  - Wrap C_Map call in existence check (`if C_Map and C_Map.GetBestMapForUnit then`)

**Section 5: Day/Night Detection (MFIX-03)**
- `isDayTime()` -- returns true if `GetGameTime()` hours >= 6 and < 18
- Per user decision: day/night detection is in Phase 1. Breakpoints 6:00/18:00 per research (closest available approximation of WoW's built-in cycle).

**Section 6: Music Playback (MFIX-03, MFIX-04, MFIX-05, MFIX-09)**
- `getRandomTrack()` -- picks random track from day or night pool based on isDayTime()
- `playNagrandMusic()`:
  1. Check `GetCVar("Sound_EnableMusic") == "1"` -- if music disabled, print info message and return (MFIX-04 pitfall 5)
  2. Get a random track via getRandomTrack()
  3. If `currentTrackID` is already set AND belongs to the correct time-of-day pool, do NOT restart (MFIX-05 seamless continuation). This handles both subzone transitions AND the case where playNagrandMusic is called redundantly.
  4. Call `PlayMusic(newTrack)` -- this auto-fades the buggy built-in zone music (MFIX-04 primary suppression)
  5. Set `currentTrackID = newTrack` and `isActive = true`
  6. Set `lastTimeOfDay = isDayTime()`
  - NOTE: Do NOT call StopMusic() before PlayMusic() within Nagrand -- this creates a gap where drums can re-assert (anti-pattern from research)
  - If PlayMusic somehow fails or track is nil, call printError with details

- `stopNagrandMusic()`:
  1. If not isActive, return
  2. Call `StopMusic()` -- only stops addon-played music, built-in zone music resumes for other zones
  3. Reset: `currentTrackID = nil`, `isActive = false`, `lastTimeOfDay = nil`

**Section 7: Day/Night Monitoring (MFIX-03)**
- `startDayNightTimer()`:
  1. If not isActive, return (stop the timer chain)
  2. Check isDayTime() against lastTimeOfDay
  3. If changed: pick new random track from the new time pool, call PlayMusic(newTrack), update currentTrackID and lastTimeOfDay
  4. Schedule next check: `C_Timer.After(60, startDayNightTimer)`
  - This creates a self-sustaining timer that runs every 60 seconds while in Nagrand

**Section 8: Activation/Deactivation (MFIX-06, MFIX-08)**
- `activateAddon()`:
  1. Save `savedMusicCVar = GetCVar("Sound_EnableMusic")`
  2. Call `playNagrandMusic()` -- if music is disabled, playNagrandMusic handles the message
  3. If isActive after playNagrandMusic (meaning it succeeded): start the day/night timer via `startDayNightTimer()`

- `deactivateAddon()`:
  1. Call `stopNagrandMusic()`
  2. If savedMusicCVar was saved and CVar was modified, restore it: `SetCVar("Sound_EnableMusic", savedMusicCVar)`
  3. Reset `savedMusicCVar = nil`

**Section 9: Event Handlers (MFIX-01, MFIX-06, MFIX-07, MFIX-08)**
- `handlers.ZONE_CHANGED_NEW_AREA()`:
  1. Use `C_Timer.After(0, ...)` to defer by one frame (zone data may not be current yet)
  2. In the callback: if `isInNagrand()` and not isActive, call activateAddon()
  3. If not isInNagrand() and isActive, call deactivateAddon()

- `handlers.ZONE_CHANGED()`:
  1. If isActive: call playNagrandMusic() -- this is a no-op if the current track is still valid (same time-of-day pool). Exists to re-assert PlayMusic if the zone system tried to restart drums on subzone boundary.
  2. If not isActive: do nothing (MFIX-06)

- `handlers.ZONE_CHANGED_INDOORS()`:
  1. Same as ZONE_CHANGED -- re-assert PlayMusic if active, otherwise do nothing
  2. Per research: Nagrand has no separate indoor music, so indoor/outdoor transitions keep playing the same track

- `handlers.PLAYER_ENTERING_WORLD(isInitialLogin, isReloadingUi)`:
  1. Use `C_Timer.After(0, ...)` to defer by one frame (MFIX-07 loading screen recovery)
  2. In the callback: if isInNagrand(), call activateAddon()
  3. If not isInNagrand() and isActive, call deactivateAddon()

- `handlers.PLAYER_LOGOUT()`:
  1. Call deactivateAddon() (MFIX-08 cleanup)

**Section 10: Frame Setup**
- `local frame = CreateFrame("Frame")`
- Set OnEvent script: dispatch to handlers table using `handlers[event](...)`
- Register all events: iterate `for event in pairs(handlers)` and call `frame:RegisterEvent(event)`

**Implementation Notes (from research -- DO NOT IGNORE):**
- NEVER call StopMusic() then PlayMusic() within Nagrand -- use PlayMusic() directly to replace tracks
- The `currentTrackID` check in playNagrandMusic MUST compare against the correct pool (day vs night), not just check if any track is playing. If the time-of-day has changed, the current track is "wrong" even if it's still playing.
- Use `math.random(#pool)` for track selection. Lua's math.random is seeded by WoW client.
- All error paths must call printError() -- no silent failures (user decision).
- The addon must be completely inert outside Nagrand (MFIX-06). No timers running, no events processing beyond the zone check.
  </action>
  <verify>
1. File exists at `FixNagrandMusic/FixNagrandMusic.lua`
2. File contains NAGRAND_TRACKS table with exactly 6 FileDataIDs (53585-53590)
3. File contains isInNagrand() function with dual-method detection
4. File contains isDayTime() function checking GetGameTime()
5. File contains playNagrandMusic() with currentTrackID check and PlayMusic call
6. File contains stopNagrandMusic() with StopMusic call
7. File contains startDayNightTimer() with C_Timer.After(60, ...)
8. File contains handlers for: ZONE_CHANGED_NEW_AREA, ZONE_CHANGED, ZONE_CHANGED_INDOORS, PLAYER_ENTERING_WORLD, PLAYER_LOGOUT
9. File contains activateAddon() and deactivateAddon() functions
10. File contains Sound_EnableMusic CVar check before playing
11. File contains error/info printing functions
12. No calls to StopMusic() immediately before PlayMusic() within Nagrand logic paths
  </verify>
  <done>
FixNagrandMusic.lua contains all core music fix logic: zone detection (MFIX-01, MFIX-02), music playback with day/night variants (MFIX-03), drum suppression via PlayMusic auto-fade (MFIX-04), seamless subzone transitions (MFIX-05), no-op outside Nagrand (MFIX-06), loading screen recovery (MFIX-07), cleanup on exit/logout (MFIX-08), and empty subzone handling (MFIX-09). The addon is a complete, loadable WoW addon.
  </done>
</task>

</tasks>

<verification>
1. Both files exist in `FixNagrandMusic/` directory
2. TOC references the Lua file correctly
3. Lua file has no syntax errors (check with `luac -p FixNagrandMusic/FixNagrandMusic.lua` if luac is available, otherwise manual review)
4. All 10 requirements (MFIX-01 through MFIX-09, PKG-01) are addressed in the code
5. No use of avoided patterns: no Ace3, no XML, no OnUpdate polling, no file path strings
6. Code follows the event-driven frame handler pattern from research
7. Day/night timer only runs while in Nagrand (stops on deactivation)
8. CVar is saved before modification and restored on deactivation
</verification>

<success_criteria>
- `FixNagrandMusic/` directory contains exactly 2 files: .toc and .lua
- Addon can be placed in WoW's `Interface/AddOns/` and would load without errors
- All MFIX requirements have corresponding code paths in the Lua file
- TOC has correct Interface version (20505) and file reference
- Code is well-commented with section headers for maintainability
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-music-fix/01-01-SUMMARY.md`
</output>
