---
phase: 01-core-music-fix
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - FixNagrandMusic/FixNagrandMusic.lua
  - FixNagrandMusic/FixNagrandMusic.toc
autonomous: false
requirements:
  - MFIX-01
  - MFIX-03
  - MFIX-04
  - MFIX-07

must_haves:
  truths:
    - "Addon activates when player enters Nagrand in-game"
    - "Correct Nagrand music plays (not Orgrimmar drums)"
    - "Music survives subzone transitions without drum bursts"
    - "Music restarts after loading screen (hearthstone back to Nagrand)"
    - "UiMapID for Nagrand is confirmed and hardcoded correctly"
  artifacts:
    - path: "FixNagrandMusic/FixNagrandMusic.lua"
      provides: "Validated addon with confirmed UiMapID and suppression strategy"
      contains: "NAGRAND_MAP_ID"
  key_links:
    - from: "FixNagrandMusic/FixNagrandMusic.lua"
      to: "WoW client"
      via: "In-game validation of PlayMusic suppression and zone detection"
      pattern: "PlayMusic"
---

<objective>
Validate the addon in-game and fix any issues discovered during testing. The research identified three open questions that can ONLY be resolved by running the addon in the WoW client: (1) the exact UiMapID for Nagrand in TBC Anniversary, (2) whether PlayMusic reliably suppresses the buggy drums across subzone transitions, and (3) the Interface version.

Purpose: The addon's correctness depends on in-game behavior that cannot be verified from documentation alone. This plan gates Phase 2 on confirmed working behavior.

Output: A validated, working addon with any necessary fixes applied based on in-game testing.
</objective>

<execution_context>
@/home/mig/.claude/get-shit-done/workflows/execute-plan.md
@/home/mig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-music-fix/01-RESEARCH.md
@.planning/phases/01-core-music-fix/01-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: In-game validation of core addon behavior</name>
  <files>FixNagrandMusic/FixNagrandMusic.lua, FixNagrandMusic/FixNagrandMusic.toc</files>
  <action>
Present the following verification steps to the user. The addon was built in Plan 01. The user must test it in-game to validate open questions from research (UiMapID, drum suppression, Interface version).

**What was built:** Complete FixNagrandMusic addon -- zone detection, music playback with day/night variants, drum suppression, loading screen recovery, and cleanup.

**User must perform these tests:**

Setup:
1. Copy `FixNagrandMusic/` folder to WoW `Interface/AddOns/` directory
2. Launch WoW TBC Classic Anniversary client
3. Log in with a character that can reach Nagrand

Test 1 - Addon loads (PKG-01): Check AddOns list -- FixNagrandMusic should appear and be enabled. If it shows "out of date," note the error.

Test 2 - Confirm UiMapID (MFIX-01): Travel to Nagrand. Run: `/run print("MapID:", C_Map.GetBestMapForUnit("player"))`. Report the number shown. If NOT 107, addon needs a code fix.

Test 3 - Confirm Interface version: Run: `/dump (select(4, GetBuildInfo()))`. Report the number. If NOT 20505, TOC needs updating.

Test 4 - Music plays on entry (MFIX-03, MFIX-04): Fly or ride INTO Nagrand from another zone. Listen: correct Nagrand music plays? Orgrimmar drums gone? If drums persist under Nagrand music, report "dual layering."

Test 5 - Subzone transitions (MFIX-05): Walk between 2-3 subzones (e.g., Sunspring Post to Garadar to open grassland). Music should continue uninterrupted, no drum bursts.

Test 6 - Loading screen recovery (MFIX-07): Hearthstone to a city, then fly back to Nagrand. Music should resume within 1-2 seconds.

Test 7 - Zone exit cleanup (MFIX-08): Fly OUT of Nagrand. Nagrand music should stop, new zone music plays normally.

**User reports:** UiMapID number, Interface version, pass/fail for Tests 4-7, any errors or audio issues. Type "all pass" if everything works, or describe specific failures.
  </action>
  <verify>User has provided test results for all 7 tests.</verify>
  <done>User has reported in-game test results. Proceed to Task 2 with the results.</done>
</task>

<task type="auto">
  <name>Task 2: Apply fixes based on in-game test results</name>
  <files>FixNagrandMusic/FixNagrandMusic.lua, FixNagrandMusic/FixNagrandMusic.toc</files>
  <action>
Apply fixes based on the user's test report from Task 1. The most likely fixes are:

**If UiMapID is not 107:**
- Update `NAGRAND_MAP_ID` in FixNagrandMusic.lua to the reported value
- If GetBestMapForUnit returns nil or errors, remove the C_Map path and rely solely on GetZoneText

**If Interface version is not 20505:**
- Update `## Interface:` in FixNagrandMusic.toc to the reported value

**If dual music layering (drums persist under addon music):**
- Upgrade to suppression Strategy B: Add `SetCVar("Sound_EnableMusic", "0")` before PlayMusic, then `SetCVar("Sound_EnableMusic", "1")` after, to kill the built-in zone music channel before replacing it
- If Strategy B fails: Upgrade to Strategy C: Add `MuteSoundFile()` calls for the specific Orgrimmar drum FileDataIDs (these would need to be identified from the game files -- ask user to report what they hear)

**If music doesn't restart after loading screen:**
- Increase the C_Timer.After delay from 0 to 0.5 or 1.0 seconds
- Add a secondary ZONE_CHANGED_NEW_AREA handler as backup

**If "all pass":**
- No changes needed. Mark task as complete with no modifications.

This task is conditional -- it may result in zero file changes if all tests pass.
  </action>
  <verify>If fixes were applied: re-read modified files and confirm changes are consistent with the rest of the code. If no fixes needed: verify user reported "all pass."</verify>
  <done>Addon is validated working in-game. UiMapID is confirmed. Drum suppression strategy is confirmed. All Phase 1 success criteria are met.</done>
</task>

</tasks>

<verification>
1. User confirmed addon loads in WoW client
2. UiMapID for Nagrand is validated and correct in code
3. Interface version is validated and correct in TOC
4. Music plays correctly on Nagrand entry (no drums)
5. Music survives subzone transitions
6. Music restarts after loading screens
7. Music stops on zone exit
</verification>

<success_criteria>
- User reports "all pass" or all reported issues have been fixed and re-verified
- NAGRAND_MAP_ID in code matches the actual in-game value
- Interface version in TOC matches the actual client version
- Drum suppression strategy is confirmed working (Strategy A, B, or C)
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-music-fix/01-02-SUMMARY.md`
</output>
